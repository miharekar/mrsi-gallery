(function(d,e,c){var a=function(i){var f={images:[],shuffle:false,transitionTime:1000,type:"cover",cssTransitions:false};i=d.extend({},f,i);this.setImages(i.images,i.shuffle);this.detectTerribleBrowser();this.detectTransitionType();this.setTransitionTime(i.transitionTime);this.type=i.type;this.enableCSSTransitions(i.cssTransitions);var h=this;var g=function(){h.oldDiv.remove();h.running=false};var j=function(){h.running=false};this.hiddenImg.load(function(){if(!h.running){return}h.addBackgroundImage(h.images[h.current]);h.loadingDiv.hide();if(h.oldDiv!==null){if(h.transitionType){h.oldDiv.css(h.transitionClass).addClass("fadeout").bind(h.transitionType,g)}else{h.oldDiv.fadeOut(h.transitionTime,g)}}else{if(h.transitionType){h.backgroundDiv.css(h.transitionClass).removeClass("fadeout").bind(h.transitionType,j)}else{h.backgroundDiv.fadeIn(h.transitionTime,j)}}});this.running=true;this.hiddenImg.attr("src",this.images[this.current])};a.prototype.emptyDiv='<div class="background new"></div>';a.prototype.oldDiv=null;a.prototype.hiddenImg=d('<img id="hiddenImg"/>').appendTo("body");a.prototype.loadingDiv=d('<div id="loading"></div>').appendTo("body");a.prototype.setTransitionTime=function(f){this.transitionTime=parseInt(f,10);f=f+"ms";this.transitionClass={transition:f,"-moz-transition":f,"-webkit-transition":f,"-o-transition":f}};a.prototype.enableCSSTransitions=function(f){this.transitionType=f?this.detectTransitionType():false};var b=function(f){var l,k=f.slice(),h=k.length,g;while(h){h=h-1;g=Math.round(Math.random()*h);l=k[g];k[g]=k[h];k[h]=l}return k};a.prototype.setImages=function(f,g){if(g){f=b(f)}this.images=f;this.imagesMax=this.images.length-1;this.current=0};a.prototype.setNewImages=function(h){var f={images:[],shuffle:false};h=d.extend({},f,h);var g=this.images[this.current];this.setImages(h.images,h.shuffle);if(g!==this.images[this.current]){this.changeImage()}};a.prototype.toggleType=function(){var f=this;if(!this.running&&!this.isTerribleBrowser){var g=this.type;this.running=true;this.type=(this.type==="cover")?"contain":"cover";if(f.transitionType){this.backgroundDiv.css(f.transitionClass).addClass("fadeout").bind(this.transitionType,function(){d(this).removeClass(g).addClass(f.type).removeClass("fadeout").unbind(f.transitionType).bind(f.transitionType,function(){f.running=false;d(this).unbind(f.transitionType)})})}else{this.backgroundDiv.fadeOut("",function(){d(this).removeClass(g).addClass(f.type).fadeIn("",function(){f.running=false})})}return true}return};a.prototype.next=function(){if(this.running){return}this.current=(this.current===this.imagesMax)?0:this.current+1;return this.changeImage()};a.prototype.previous=function(){if(this.running){return}this.current=(this.current===0)?this.imagesMax:this.current-1;return this.changeImage()};a.prototype.changeTo=function(f){if(f<=this.imagesMax&&f>=0&&f!==this.current){this.current=f;return this.changeImage()}return};a.prototype.detectTerribleBrowser=function(){if(/MSIE (\d+\.\d+);/.test(c.navigator.userAgent)){this.isTerribleBrowser=parseFloat(RegExp.$1,10)<9}};a.prototype.detectTransitionType=function(){var f={WebkitTransition:"webkitTransitionEnd",MozTransition:"transitionend",OTransition:"oTransitionEnd",transition:"transitionEnd"};return e.csstransitions?f[e.prefixed("transition")]:false};a.prototype.addBackgroundImage=function(h){if(this.backgroundDiv===undefined){if(this.transitionType){this.backgroundDiv=d(a.prototype.emptyDiv).addClass("fadeout").appendTo("body")}else{this.backgroundDiv=d(a.prototype.emptyDiv).hide().appendTo("body")}}var g=this.backgroundDiv;if(this.isTerribleBrowser){var f="progid:DXImageTransform.Microsoft.AlphaImageLoader(src='"+h+"', sizingMethod='scale')";g.css({filter:f,"-ms-filter":f})}else{g.css("background-image","url("+h+")").addClass(this.type)}};a.prototype.changeImage=function(){var f=this;if(!this.running){this.oldDiv=this.backgroundDiv;this.backgroundDiv=d(this.emptyDiv).insertBefore(this.oldDiv);this.running=true;this.loadingDiv.show();this.oldDiv.addClass("old").removeClass("new");this.hiddenImg.attr("src",f.images[f.current]);return true}return};c.gallery=a}(jQuery,Modernizr,window));